<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>NUCC Skill Progression Graph (Manual Coords)</title>
  <script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://unpkg.com/cytoscape/dist/cytoscape.min.js"></script>
  <style>
    body { margin:0; background:#fafafa; }
    #cy { width:100vw; height:100vh; }
  </style>
</head>
<body>
<div id="cy"></div>
<script>
async function loadCSV(path) {
  const response = await fetch(path);
  const text = await response.text();
  return new Promise(resolve => {
    Papa.parse(text, {
      header: true,
      skipEmptyLines: true,
      complete: results => resolve(results.data)
    });
  });
}

(async function init() {
  const rows = await loadCSV('definition.csv');

  const nodes = [];
  const edges = [];

  rows.forEach(row => {
    const id = row.id?.trim();
    if (!id) return;

    const color = row.color?.trim() || '#cccccc';
    const x = parseFloat(row.x) || 0;
    const y = parseFloat(row.y) || 0;

    nodes.push({
      data: { id, color },
      position: { x, y }
    });

    const prereq = row.prereq?.trim();
    if (prereq) {
      prereq.split(/[;,]/).forEach(p => {
        const src = p.trim();
        if (src)
          edges.push({ data: { source: src, target: id } });
      });
    }
  });

  const cy = cytoscape({
    container: document.getElementById('cy'),
    elements: [
      ...nodes.map(n => ({ data: n.data, position: n.position })),
      ...edges.map(e => ({ data: e.data }))
    ],
    style: [
      { selector: 'node', style: {
          'background-color': 'data(color)',
          'label': 'data(id)',
          'color': '#333',
          'text-wrap': 'wrap',
          'text-max-width': 130,
          'font-size': 11,
          'text-valign': 'center',
          'text-halign': 'center'
      }},
      { selector: 'edge', style: {
          'width': 2,
          'target-arrow-shape': 'triangle',
          'line-color': '#bbb',
          'target-arrow-color': '#bbb',
          'curve-style': 'bezier'
      }},
      { selector: '.dimmed', style: { 'opacity': 0.2 } },
      { selector: '.highlighted', style: { 'border-width': 3, 'border-color': '#333' } }
    ],
    layout: { name: 'preset' }
  });

  cy.on('tap', 'node', evt => {
    const node = evt.target;
    cy.elements().removeClass('highlighted').addClass('dimmed');
    node.removeClass('dimmed').addClass('highlighted');
    node.connectedEdges().removeClass('dimmed');
    node.connectedEdges().targets().removeClass('dimmed');
  });

  cy.on('tap', evt => {
    if (evt.target === cy)
      cy.elements().removeClass('dimmed highlighted');
  });
})();
</script>
</body>
</html>
